<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>抽獎活動</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- jQuery / jQuery UI (for sortable) -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
    />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <style>
      #wheel {
        border: 2px solid #ccc;
        border-radius: 50%;
        background: #fff;
      }
      .card {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      }
      .list-group-item {
        cursor: grab;
      }
      /* 參與名單三行收折 */
      #wheelNames {
        white-space: normal;
        word-break: break-word;
      }
      .clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div class="container mt-3">
      <!-- 活動名稱區 -->
      <div class="row mb-3">
        <div class="col-12 d-flex align-items-center">
          <!-- 放同層的圖片檔名 -->
          <img
            src="gce.png"
            alt="活動Logo"
            style="height: 40px; margin-right: 10px"
          />
          <h2 class="mb-0">齊心協力 益起健走</h2>
          <div class="ms-auto d-flex align-items-center gap-3">
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="soundSwitch"
                checked
              />
              <label class="form-check-label" for="soundSwitch">音效</label>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- 左側：名單與獎項 -->
        <div class="col-md-5">
          <div class="card mb-3">
            <div
              class="card-header d-flex align-items-center justify-content-between"
            >
              <span>名單輸入區</span>
              <div class="btn-group btn-group-sm">
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  id="exportNamesCsvBtn"
                >
                  匯出名單 CSV
                </button>
                <button
                  type="button"
                  class="btn btn-outline-primary"
                  id="importNamesCsvBtn"
                >
                  匯入名單 CSV
                </button>
                <input
                  type="file"
                  id="importNamesCsvInput"
                  accept=".csv"
                  hidden
                />
              </div>
            </div>
            <div class="card-body">
              <textarea
                id="participants"
                class="form-control mb-2"
                rows="8"
                placeholder="每行一個名額"
              ></textarea>
              <div class="mb-2">
                <button
                  type="button"
                  class="btn btn-primary btn-sm"
                  id="importBtn"
                >
                  匯入名單（文字框）
                </button>
                <button
                  type="button"
                  class="btn btn-secondary btn-sm"
                  id="clearBtn"
                >
                  清除
                </button>
              </div>
              <div>目前名單數：<span id="count">0</span></div>
            </div>
          </div>

          <div class="card mb-3">
            <div
              class="card-header d-flex align-items-center justify-content-between"
            >
              <span>獎項資料輸入區</span>
              <div class="btn-group btn-group-sm">
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  id="exportPrizesCsvBtn"
                >
                  匯出獎項 CSV
                </button>
                <button
                  type="button"
                  class="btn btn-outline-primary"
                  id="importPrizesCsvBtn"
                >
                  匯入獎項 CSV
                </button>
                <input
                  type="file"
                  id="importPrizesCsvInput"
                  accept=".csv"
                  hidden
                />
              </div>
            </div>
            <div class="card-body">
              <div class="input-group mb-2">
                <input
                  type="text"
                  id="prizeName"
                  class="form-control"
                  placeholder="獎項名稱"
                />
                <input
                  type="number"
                  id="prizeCount"
                  class="form-control"
                  value="1"
                  min="1"
                  style="max-width: 90px"
                />
                <button type="button" class="btn btn-success" id="addPrize">
                  新增
                </button>
              </div>
              <div id="prizeList" class="list-group"></div>
            </div>
          </div>
        </div>

        <!-- 右側：轉盤與紀錄 -->
        <div class="col-md-7">
          <div class="card mb-3">
            <div class="card-header">抽獎轉盤區</div>
            <div class="card-body text-center">
              <div id="currentPrize" class="mb-2 fw-bold"></div>
              <canvas
                id="wheel"
                width="300"
                height="300"
                style="margin-bottom: 10px"
              ></canvas>
              <div>
                <button class="btn btn-warning" id="drawBtn">抽獎</button>
              </div>

              <!-- 參與名單（可收折） -->
              <div class="mt-3 text-start">
                <div class="mb-1 fw-semibold">參與名單：</div>
                <div id="wheelNames" class="clamp-3"></div>
                <button id="toggleNames" class="btn btn-link btn-sm p-0 mt-1">
                  展開全部
                </button>
              </div>
            </div>
          </div>

          <div class="card">
            <div
              class="card-header d-flex align-items-center justify-content-between"
            >
              <span>抽獎紀錄</span>
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm"
                id="exportWinnersCsvBtn"
              >
                匯出中獎名單 CSV
              </button>
            </div>
            <div class="card-body">
              <ul id="winnerList" class="list-group"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 中獎彈跳視窗 -->
    <div
      class="modal fade"
      id="winnerModal"
      tabindex="-1"
      aria-labelledby="winnerModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="winnerModalLabel">🎉 恭喜中獎！</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="關閉"
            ></button>
          </div>
          <div class="modal-body text-center">
            <div
              id="modalPrize"
              style="font-size: 1.2em; font-weight: bold"
            ></div>
            <div
              id="modalWinner"
              style="font-size: 2em; color: #d9534f; margin: 10px 0"
            ></div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              id="nextDrawBtn"
              data-bs-dismiss="modal"
            >
              準備下一抽
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ===== 狀態 =====
      let participants = [];
      let prizes = [];
      let winners = [];
      let currentPrizeIdx = 0;
      let isDrawing = false;
      let enableSound = true;

      // ===== 音效（Web Audio 產生：轉盤滴答 & 中獎小號） =====
      let audioCtx = null;
      function ensureAudio() {
        if (!audioCtx)
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      function playTick() {
        if (!enableSound) return;
        ensureAudio();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "square";
        o.frequency.value = 900;
        g.gain.value = 0.03;
        o.connect(g).connect(audioCtx.destination);
        o.start();
        setTimeout(() => {
          o.stop();
        }, 40);
      }
      function playWin() {
        if (!enableSound) return;
        ensureAudio();
        const now = audioCtx.currentTime;
        const freqs = [523.25, 659.25, 783.99, 1046.5]; // C-E-G-C
        freqs.forEach((f, i) => {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = "sine";
          o.frequency.setValueAtTime(f, now + i * 0.12);
          g.gain.setValueAtTime(0.0001, now + i * 0.12);
          g.gain.exponentialRampToValueAtTime(0.2, now + i * 0.12 + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, now + i * 0.12 + 0.25);
          o.connect(g).connect(audioCtx.destination);
          o.start(now + i * 0.12);
          o.stop(now + i * 0.12 + 0.28);
        });
      }
      $("#soundSwitch").on("change", function () {
        enableSound = this.checked;
      });

      // ===== 煙火（confetti） =====
      function fireConfetti() {
        const end = Date.now() + 800;
        (function frame() {
          confetti({ particleCount: 20, spread: 70, origin: { y: 0.6 } });
          if (Date.now() < end) requestAnimationFrame(frame);
        })();
      }

      // ===== 名單處理 =====
      function updateParticipants() {
        participants = $("#participants")
          .val()
          .split("\n")
          .map((x) => x.trim())
          .filter((x) => x !== "");
        $("#count").text(participants.length);
        updateWheel();
        updateNamesArea();
      }
      $("#participants").on("input", updateParticipants);
      $("#importBtn").on("click", updateParticipants);
      $("#clearBtn").on("click", () => {
        $("#participants").val("");
        updateParticipants();
      });

      // ===== CSV 匯入/匯出：名單 =====
      $("#importNamesCsvBtn").on("click", () =>
        $("#importNamesCsvInput").click()
      );
      $("#importNamesCsvInput").on("change", function () {
        const file = this.files[0];
        if (!file) return;
        file.text().then((text) => {
          const rows = parseCSV(text);
          if (rows.length === 0) {
            return Swal.fire("匯入失敗", "檔案內容為空", "error");
          }
          let header = rows[0].map((x) => x.toLowerCase());
          let hasHeader = header.includes("name") || header.includes("姓名");
          let start = hasHeader ? 1 : 0;
          let names = [];
          for (let i = start; i < rows.length; i++) {
            const row = rows[i];
            const val = (row[0] || "").trim();
            if (val) names.push(val);
          }
          if (names.length === 0)
            return Swal.fire("匯入失敗", "找不到任何名字", "error");
          $("#participants").val(names.join("\n"));
          updateParticipants();
          this.value = "";
          Swal.fire("匯入完成", `共 ${names.length} 筆名單`, "success");
        });
      });
      $("#exportNamesCsvBtn").on("click", function () {
        const csv = toCSV([["name"], ...participants.map((n) => [n])]);
        downloadCsv(csv, "participants.csv");
      });

      // ===== CSV 匯入/匯出：獎項 =====
      $("#importPrizesCsvBtn").on("click", () =>
        $("#importPrizesCsvInput").click()
      );
      $("#importPrizesCsvInput").on("change", function () {
        const file = this.files[0];
        if (!file) return;
        file.text().then((text) => {
          const rows = parseCSV(text);
          if (rows.length === 0) {
            return Swal.fire("匯入失敗", "檔案內容為空", "error");
          }
          let header = rows[0].map((x) => x.toLowerCase());
          let hasHeader =
            header.includes("name") ||
            header.includes("獎項") ||
            header.includes("prize");
          let start = hasHeader ? 1 : 0;
          const list = [];
          for (let i = start; i < rows.length; i++) {
            const r = rows[i];
            const name = (r[0] || "").trim();
            const count = parseInt((r[1] || "1").trim(), 10);
            if (name && Number.isFinite(count) && count > 0)
              list.push({ name, count });
          }
          if (list.length === 0)
            return Swal.fire(
              "匯入失敗",
              "無有效獎項資料（需兩欄：name,count）",
              "error"
            );
          prizes = list;
          renderPrizes();
          updateCurrentPrize();
          this.value = "";
          Swal.fire("匯入完成", `共 ${list.length} 個獎項`, "success");
        });
      });
      $("#exportPrizesCsvBtn").on("click", function () {
        const rows = [
          ["name", "count"],
          ...prizes.map((p) => [p.name, String(p.count)]),
        ];
        downloadCsv(toCSV(rows), "prizes.csv");
      });

      // ===== 匯出中獎名單 =====
      $("#exportWinnersCsvBtn").on("click", function () {
        const rows = [
          ["order", "prize", "name", "time"],
          ...winners.map((w) => [w.order, w.prize, w.name, w.time]),
        ];
        downloadCsv(toCSV(rows), "winners.csv");
      });

      // ===== CSV 工具 =====
      function downloadCsv(csv, filename) {
        const blob = new Blob(["\ufeff" + csv], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }
      function toCSV(rows) {
        return rows
          .map((r) =>
            r
              .map((cell) => {
                const s = String(cell ?? "");
                if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
                return s;
              })
              .join(",")
          )
          .join("\n");
      }
      // 簡單 CSV 解析（支援引號、逗號、換行）
      function parseCSV(text) {
        const rows = [];
        let row = [];
        let i = 0;
        let cur = "";
        let inQ = false;
        // 去除 BOM
        if (text.charCodeAt(0) === 0xfeff) text = text.slice(1);
        while (i < text.length) {
          const ch = text[i];
          if (inQ) {
            if (ch === '"') {
              if (text[i + 1] === '"') {
                cur += '"';
                i += 2;
                continue;
              }
              inQ = false;
              i++;
              continue;
            } else {
              cur += ch;
              i++;
              continue;
            }
          } else {
            if (ch === '"') {
              inQ = true;
              i++;
              continue;
            }
            if (ch === ",") {
              row.push(cur);
              cur = "";
              i++;
              continue;
            }
            if (ch === "\n") {
              row.push(cur);
              rows.push(row);
              row = [];
              cur = "";
              i++;
              continue;
            }
            if (ch === "\r") {
              i++;
              continue;
            }
            cur += ch;
            i++;
          }
        }
        row.push(cur);
        rows.push(row);
        // 去掉可能的空白行
        return rows.filter((r) => !(r.length === 1 && r[0].trim() === ""));
      }

      // ===== 獎項新增 / 排序 / 刪除 =====
      $("#addPrize").on("click", function () {
        const name = $("#prizeName").val().trim();
        const count = parseInt($("#prizeCount").val(), 10);
        if (!name || !Number.isFinite(count) || count <= 0) {
          return Swal.fire(
            "資料不完整",
            "請輸入有效的獎項名稱與數量",
            "warning"
          );
        }
        prizes.push({ name, count });
        $("#prizeName").val("");
        $("#prizeCount").val(1);
        renderPrizes();
        updateCurrentPrize();
      });

      function renderPrizes() {
        const $list = $("#prizeList").empty();
        prizes.forEach((p, i) => {
          $list.append(
            `<div class="list-group-item d-flex justify-content-between align-items-center" data-idx="${i}">
           <span>${i + 1}. ${p.name} <span class="badge bg-secondary">${
              p.count
            }</span></span>
           <button type="button" class="btn btn-danger btn-sm removePrize">刪除</button>
         </div>`
          );
        });
        // sortable
        $("#prizeList").sortable({
          update: function () {
            const old = prizes.slice();
            const newOrderIdx = $(this)
              .children()
              .map(function () {
                return $(this).data("idx");
              })
              .get();
            prizes = newOrderIdx.map((idx) => old[idx]);
            renderPrizes();
            updateCurrentPrize();
          },
        });
      }
      $("#prizeList").on("click", ".removePrize", function () {
        const idx = $(this).closest(".list-group-item").data("idx");
        prizes.splice(idx, 1);
        renderPrizes();
        updateCurrentPrize();
      });

      // ===== 轉盤 =====
      function updateWheel() {
        const canvas = document.getElementById("wheel");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        const names = participants;
        const len = names.length;
        ctx.clearRect(0, 0, 300, 300);
        if (!len) return;
        const angle = (2 * Math.PI) / len;
        for (let i = 0; i < len; i++) {
          ctx.beginPath();
          ctx.moveTo(150, 150);
          ctx.arc(150, 150, 140, i * angle, (i + 1) * angle);
          ctx.closePath();
          ctx.fillStyle = `hsl(${(i * 360) / len},70%,70%)`;
          ctx.fill();
          ctx.save();
          ctx.translate(150, 150);
          ctx.rotate((i + 0.5) * angle);
          ctx.textAlign = "right";
          ctx.font = "16px Arial";
          ctx.fillStyle = "#333";
          ctx.fillText(names[i], 130, 8);
          ctx.restore();
        }
        // 指針
        ctx.beginPath();
        ctx.moveTo(150, 10);
        ctx.lineTo(140, 30);
        ctx.lineTo(160, 30);
        ctx.closePath();
        ctx.fillStyle = "#d9534f";
        ctx.fill();
      }

      function highlightWheel(idx) {
        updateWheel();
        const canvas = document.getElementById("wheel");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        const len = participants.length;
        if (!len) return;
        const angle = (2 * Math.PI) / len;
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(150, 150);
        ctx.arc(150, 150, 140, idx * angle, (idx + 1) * angle);
        ctx.closePath();
        ctx.fillStyle = "rgba(255,215,0,.5)";
        ctx.fill();
        ctx.restore();
      }

      // ===== 參與名單顯示（3 行收折） =====
      function updateNamesArea() {
        $("#wheelNames").text(participants.join(", "));
        clampNames(true);
        // 判斷是否需要顯示按鈕（內容高度超過 3 行）
        const el = document.getElementById("wheelNames");
        const needBtn = el.scrollHeight > el.clientHeight + 1;
        $("#toggleNames").toggle(needBtn);
      }
      function clampNames(shouldClamp) {
        const $names = $("#wheelNames");
        if (shouldClamp) {
          $names.addClass("clamp-3");
          $("#toggleNames").text("展開全部");
        } else {
          $names.removeClass("clamp-3");
          $("#toggleNames").text("收合");
        }
        $("#toggleNames").data("expanded", !shouldClamp);
      }
      $("#toggleNames").on("click", function () {
        const expanded = $(this).data("expanded") === true;
        clampNames(expanded); // 如果已展開 -> 收合；若收合 -> 展開
      });

      // ===== 顯示目前獎項 =====
      function updateCurrentPrize() {
        if (prizes.length > 0 && currentPrizeIdx < prizes.length) {
          $("#currentPrize").text("當前獎項：" + prizes[currentPrizeIdx].name);
        } else {
          $("#currentPrize").text("所有獎項已抽完");
        }
      }

      // ===== 抽獎 =====
      const winnerModalEl = document.getElementById("winnerModal");
      const bsWinnerModal = new bootstrap.Modal(winnerModalEl);

      $("#drawBtn").on("click", function () {
        if (isDrawing) return;

        if (currentPrizeIdx >= prizes.length) {
          return Swal.fire(
            "所有獎項已抽完",
            "請新增獎項或重新整理頁面",
            "info"
          );
        }
        if (participants.length === 0 || prizes.length === 0) {
          return Swal.fire("資料不足", "請確認名單與獎項皆已設定", "warning");
        }
        if (prizes[currentPrizeIdx].count <= 0) {
          currentPrizeIdx++;
          updateCurrentPrize();
          if (currentPrizeIdx >= prizes.length) {
            return Swal.fire(
              "所有獎項已抽完",
              "請新增獎項或重新整理頁面",
              "info"
            );
          }
          return;
        }

        isDrawing = true;
        const winnerIdx = Math.floor(Math.random() * participants.length);
        const rounds = 20 + Math.floor(Math.random() * 10);
        let step = 0;
        const timer = setInterval(() => {
          const idx = (winnerIdx + step) % participants.length;
          highlightWheel(idx);
          playTick();
          step++;
          if (step > rounds) {
            clearInterval(timer);
            setTimeout(() => showWinner(winnerIdx), 500);
          }
        }, 80);
      });

      function showWinner(winnerIdx) {
        const winner = participants[winnerIdx];
        const prizeName = prizes[currentPrizeIdx].name;

        // 彈窗
        $("#modalPrize").text("獎項：" + prizeName);
        $("#modalWinner").text(winner);
        bsWinnerModal.show();

        playWin();
        fireConfetti();

        // 紀錄（最新在最上面）
        const now = new Date();
        winners.unshift({
          order: winners.length + 1,
          prize: prizeName,
          name: winner,
          time: now.toLocaleString(),
        });
        $("#winnerList").prepend(
          `<li class="list-group-item">${winners[0].order}. ${winners[0].prize} - ${winners[0].name}
        <span class="text-muted float-end">${winners[0].time}</span></li>`
        );

        // **一次移除名單中所有重複的中獎者**
        participants = participants.filter((n) => n !== winner);
        $("#participants").val(participants.join("\n"));

        // 扣獎數 / 切下個獎項
        prizes[currentPrizeIdx].count--;
        if (prizes[currentPrizeIdx].count <= 0) {
          currentPrizeIdx++;
        }

        updateParticipants(); // 會順便重畫轉盤 & 名單區
        renderPrizes();
        updateCurrentPrize();
        isDrawing = false;
      }

      $("#nextDrawBtn").on("click", function () {
        if (currentPrizeIdx >= prizes.length) {
          Swal.fire("所有獎項已抽完", "恭喜完成所有抽獎！", "success");
        }
      });

      // 初始
      $(function () {
        updateParticipants();
        renderPrizes();
        updateCurrentPrize();
        clampNames(true);
        $("#toggleNames").hide(); // 初始先隱藏，內容長度再決定是否顯示
      });
    </script>
  </body>
</html>
