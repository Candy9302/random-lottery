<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>æŠ½çæ´»å‹•</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- jQuery / jQuery UI (for sortable) -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
    />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 / Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <style>
      .card {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      }
      .list-group-item {
        cursor: grab;
      }

      /* åƒèˆ‡åå–®ä¸‰è¡Œæ”¶æŠ˜ */
      #wheelNames {
        white-space: normal;
        word-break: break-word;
      }
      .clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* ===== æ‰­è›‹æ©Ÿï¼ˆåŸºç¤ï¼‰ ===== */
      .gacha {
        position: relative;
        width: 300px;
        height: 370px;
      }
      .gacha-glass {
        position: absolute;
        left: 50%;
        top: 18px;
        transform: translateX(-50%);
        width: 230px;
        height: 230px;
        border-radius: 50%;
        background: radial-gradient(
            ellipse at 30% 30%,
            rgba(255, 255, 255, 0.8),
            rgba(255, 255, 255, 0.2) 40%,
            rgba(255, 255, 255, 0) 60%
          ),
          rgba(135, 206, 250, 0.35);
        border: 4px solid #cce9ff;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.06);
        /* â˜… è®“ç»ç’ƒè‰™è£åˆ‡å…§å®¹ï¼ˆæ—‹è½‰è† å›Šä¸æœƒæº¢å‡ºï¼‰ */
        overflow: hidden;
      }
      .gacha-neck {
        position: absolute;
        left: 50%;
        top: 240px;
        transform: translateX(-50%);
        width: 120px;
        height: 16px;
        background: #b52d2d;
        border-radius: 8px;
      }
      .gacha-body {
        position: absolute;
        left: 50%;
        top: 258px;
        transform: translateX(-50%);
        width: 260px;
        height: 72px;
        background: #e84545;
        border-radius: 12px;
        box-shadow: inset 0 -4px 0 rgba(0, 0, 0, 0.08);
      }
      .gacha-slot {
        position: absolute;
        left: 50%;
        top: 18px;
        transform: translateX(-50%);
        width: 120px;
        height: 24px;
        background: #333;
        border-radius: 6px;
        box-shadow: inset 0 2px 0 rgba(255, 255, 255, 0.15);
      }
      .gacha-handle {
        position: absolute;
        right: -30px;
        top: 10px;
        width: 50px;
        height: 50px;
      }
      .gacha-handle .bar {
        position: absolute;
        left: 22px;
        top: 0;
        width: 6px;
        height: 36px;
        background: #888;
        border-radius: 3px;
        transform-origin: top center;
        transition: transform 0.3s ease;
      }
      .gacha-handle .knob {
        position: absolute;
        left: 10px;
        bottom: 0;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #ffd27a, #ffa500);
        box-shadow: inset 0 -3px 0 rgba(0, 0, 0, 0.15);
        transform-origin: 50% -10px;
        transition: transform 0.3s ease;
      }
      .gacha-tray {
        position: absolute;
        left: 50%;
        bottom: 0;
        transform: translateX(-50%);
        width: 180px;
        height: 40px;
        background: #d33;
        border-radius: 0 0 12px 12px;
        box-shadow: inset 0 6px 0 rgba(0, 0, 0, 0.08);
      }
      .gacha-tray .mouth {
        position: absolute;
        left: 50%;
        top: -12px;
        transform: translateX(-50%);
        width: 110px;
        height: 20px;
        background: #555;
        border-radius: 10px;
      }
      .gacha.crank .gacha-handle .bar {
        transform: rotate(18deg);
      }
      .gacha.crank .gacha-handle .knob {
        transform: rotate(24deg);
      }

      /* æ‰è½è† å›Šï¼ˆåˆ°æ‰˜ç›¤ï¼‰ */
      .capsule {
        --hue: 210;
        position: absolute;
        left: 50%;
        top: 40px;
        transform: translate(-50%, -160px);
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: radial-gradient(
          circle at 30% 30%,
          hsl(var(--hue) 90% 70%),
          hsl(var(--hue) 80% 45%)
        );
        box-shadow: inset 0 -4px 0 rgba(0, 0, 0, 0.15),
          0 3px 6px rgba(0, 0, 0, 0.15);
        z-index: 5;
      }
      .capsule.animate {
        animation: capsule-drop 0.9s cubic-bezier(0.2, 0.8, 0.2, 1),
          capsule-to-tray 0.7s linear 0.9s forwards,
          capsule-bounce 0.5s ease-out 1.6s forwards;
      }
      @keyframes capsule-drop {
        0% {
          transform: translate(-50%, -160px);
        }
        85% {
          transform: translate(-50%, 90px);
        }
        100% {
          transform: translate(-50%, 105px);
        }
      }
      @keyframes capsule-to-tray {
        0% {
          transform: translate(-50%, 105px);
        }
        100% {
          transform: translate(65px, 165px);
        }
      }
      @keyframes capsule-bounce {
        0% {
          transform: translate(65px, 165px);
        }
        50% {
          transform: translate(65px, 155px);
        }
        100% {
          transform: translate(65px, 165px);
        }
      }

      /* ===== å‡ç´šï¼šåˆ†é«” + é‡‘è‰²å¡ç‰‡ ===== */
      .capsule-x {
        --hue: 210;
        position: absolute;
        left: 50%;
        top: 40px;
        transform: translate(65px, 165px);
        width: 44px;
        height: 44px;
        z-index: 6;
      }
      .capsule-x .half {
        position: absolute;
        left: 0;
        width: 44px;
        height: 22px;
        background: radial-gradient(
          circle at 30% 30%,
          hsl(var(--hue) 90% 70%),
          hsl(var(--hue) 80% 45%)
        );
        box-shadow: inset 0 -4px 0 rgba(0, 0, 0, 0.12),
          0 2px 6px rgba(0, 0, 0, 0.18);
      }
      .capsule-x .half.top {
        top: 0;
        border-radius: 22px 22px 0 0;
        transform-origin: 50% 100%;
      }
      .capsule-x .half.bottom {
        bottom: 0;
        border-radius: 0 0 22px 22px;
        transform-origin: 50% 0%;
      }
      .capsule-x .ticket {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -40%) scale(0.7);
        width: 160px;
        min-height: 64px;
        padding: 8px 10px;
        text-align: center;
        background: linear-gradient(135deg, #fff6cc, #ffe08a, #ffcc4d, #ffd36b);
        color: #261b00;
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 8px 22px rgba(0, 0, 0, 0.25),
          inset 0 2px 0 rgba(255, 255, 255, 0.6);
        opacity: 0;
      }
      .capsule-x .ticket .t1 {
        font-weight: 800;
        font-size: 14px;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .capsule-x .ticket .t2 {
        margin-top: 4px;
        font-size: 13px;
        font-weight: 700;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .capsule-x .ticket::after {
        content: "";
        position: absolute;
        left: -30%;
        top: 0;
        bottom: 0;
        width: 40%;
        transform: skewX(-20deg);
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.6),
          transparent
        );
        filter: blur(1px);
        opacity: 0;
      }
      .capsule-x.reveal .half.top {
        animation: capTopOpen 0.7s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      }
      .capsule-x.reveal .half.bottom {
        animation: capBottomOpen 0.7s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      }
      .capsule-x.reveal .ticket {
        animation: ticketRise 0.75s cubic-bezier(0.2, 0.8, 0.2, 1) 0.15s
          forwards;
      }
      .capsule-x.reveal .ticket::after {
        animation: ticketShine 1.2s ease 0.35s forwards;
      }
      .capsule-x.fadeout {
        animation: capFade 0.35s ease forwards;
      }
      @keyframes capTopOpen {
        0% {
          transform: translateY(0) rotate(0);
        }
        100% {
          transform: translateY(-26px) rotate(-18deg);
        }
      }
      @keyframes capBottomOpen {
        0% {
          transform: translateY(0) rotate(0);
        }
        100% {
          transform: translateY(26px) rotate(18deg);
        }
      }
      @keyframes ticketRise {
        0% {
          transform: translate(-50%, -40%) scale(0.7);
          opacity: 0;
        }
        60% {
          transform: translate(-50%, -72%) scale(1.05);
          opacity: 1;
        }
        100% {
          transform: translate(-50%, -68%) scale(1);
          opacity: 1;
        }
      }
      @keyframes ticketShine {
        0% {
          left: -30%;
          opacity: 0;
        }
        20% {
          opacity: 0.9;
        }
        100% {
          left: 110%;
          opacity: 0;
        }
      }
      @keyframes capFade {
        to {
          opacity: 0;
          transform: translate(65px, 175px) scale(0.92);
        }
      }

      /* ===== ç»ç’ƒè‰™å…§æ—‹è½‰è† å›Šï¼ˆæ–°å¢çš„å‹•ç•«ï¼‰ ===== */
      .gacha-inner {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 210px;
        height: 210px;
        transform: translate(-50%, -50%);
        pointer-events: none;
        border-radius: 50%;
      }
      .gacha-inner .track {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 0;
        height: 0;
        will-change: transform;
        animation-duration: var(--dur, 3s);
        animation-timing-function: linear;
        animation-iteration-count: infinite;
        animation-delay: var(--delay, 0s);
      }
      .gacha-inner .track.cw {
        animation-name: spinCW;
      }
      .gacha-inner .track.ccw {
        animation-name: spinCCW;
      }
      .gacha-inner .track .orb {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: radial-gradient(
          circle at 30% 30%,
          hsl(var(--hue, 210) 90% 70%),
          hsl(var(--hue, 210) 80% 45%)
        );
        box-shadow: inset 0 -3px 0 rgba(0, 0, 0, 0.15),
          0 2px 5px rgba(0, 0, 0, 0.18);
        transform: translateX(var(--r, 80px));
      }
      @keyframes spinCW {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes spinCCW {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(-360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container mt-3">
      <!-- æ´»å‹•åç¨±å€ -->
      <div class="row mb-3">
        <div class="col-12 d-flex align-items-center">
          <img
            src="gce.png"
            alt="æ´»å‹•Logo"
            style="height: 40px; margin-right: 10px"
          />
          <h2 class="mb-0">é½Šå¿ƒå”åŠ› ç›Šèµ·å¥èµ°</h2>
          <div class="ms-auto d-flex align-items-center gap-2">
            <div class="form-check form-switch">
              <input
                class="form-check-input"
                type="checkbox"
                id="soundSwitch"
                checked
              />
              <label class="form-check-label" for="soundSwitch">éŸ³æ•ˆ</label>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- å·¦å´ï¼šåå–®èˆ‡çé … -->
        <div class="col-md-5">
          <div class="card mb-3">
            <div
              class="card-header d-flex align-items-center justify-content-between"
            >
              <span>åå–®è¼¸å…¥å€</span>
              <div class="btn-group btn-group-sm">
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  id="exportNamesCsvBtn"
                >
                  åŒ¯å‡ºåå–® CSV
                </button>
                <button
                  type="button"
                  class="btn btn-outline-primary"
                  id="importNamesCsvBtn"
                >
                  åŒ¯å…¥åå–® CSV
                </button>
                <input
                  type="file"
                  id="importNamesCsvInput"
                  accept=".csv"
                  hidden
                />
              </div>
            </div>
            <div class="card-body">
              <textarea
                id="participants"
                class="form-control mb-2"
                rows="8"
                placeholder="æ¯è¡Œä¸€å€‹åé¡"
              ></textarea>
              <div class="mb-2">
                <button
                  type="button"
                  class="btn btn-primary btn-sm"
                  id="importBtn"
                >
                  åŒ¯å…¥åå–®ï¼ˆæ–‡å­—æ¡†ï¼‰
                </button>
                <button
                  type="button"
                  class="btn btn-secondary btn-sm"
                  id="clearBtn"
                >
                  æ¸…é™¤
                </button>
              </div>
              <div>ç›®å‰åå–®æ•¸ï¼š<span id="count">0</span></div>
            </div>
          </div>

          <div class="card mb-3">
            <div
              class="card-header d-flex align-items-center justify-content-between"
            >
              <span>çé …è³‡æ–™è¼¸å…¥å€</span>
              <div class="btn-group btn-group-sm">
                <button
                  type="button"
                  class="btn btn-outline-secondary"
                  id="exportPrizesCsvBtn"
                >
                  åŒ¯å‡ºçé … CSV
                </button>
                <button
                  type="button"
                  class="btn btn-outline-primary"
                  id="importPrizesCsvBtn"
                >
                  åŒ¯å…¥çé … CSV
                </button>
                <input
                  type="file"
                  id="importPrizesCsvInput"
                  accept=".csv"
                  hidden
                />
              </div>
            </div>
            <div class="card-body">
              <div class="input-group mb-2">
                <input
                  type="text"
                  id="prizeName"
                  class="form-control"
                  placeholder="çé …åç¨±"
                />
                <input
                  type="number"
                  id="prizeCount"
                  class="form-control"
                  value="1"
                  min="1"
                  style="max-width: 90px"
                />
                <button type="button" class="btn btn-success" id="addPrize">
                  æ–°å¢
                </button>
              </div>
              <div id="prizeList" class="list-group"></div>
            </div>
          </div>
        </div>

        <!-- å³å´ï¼šæ‰­è›‹ & ç´€éŒ„ -->
        <div class="col-md-7">
          <div class="card mb-3">
            <div class="card-header">æŠ½çæ‰­è›‹å€</div>
            <div class="card-body text-center">
              <div id="currentPrize" class="mb-2 fw-bold"></div>

              <!-- æ‰­è›‹æ©Ÿ -->
              <div
                id="gachaMachine"
                class="gacha mx-auto mb-2"
                role="button"
                aria-label="é»æ“Šæ‰­è›‹æ©ŸæŠ½ç"
              >
                <div class="gacha-glass">
                  <div id="gachaInner" class="gacha-inner"></div>
                </div>
                <div class="gacha-neck"></div>
                <div class="gacha-body">
                  <div class="gacha-slot"></div>
                  <div class="gacha-handle">
                    <div class="bar"></div>
                    <div class="knob"></div>
                  </div>
                </div>
                <div class="gacha-tray"><div class="mouth"></div></div>
              </div>

              <div>
                <button class="btn btn-warning" id="drawBtn">æŠ½ç</button>
              </div>

              <!-- åƒèˆ‡åå–®ï¼ˆå¯æ”¶æŠ˜ï¼‰ -->
              <div class="mt-3 text-start">
                <div class="mb-1 fw-semibold">åƒèˆ‡åå–®ï¼š</div>
                <div id="wheelNames" class="clamp-3"></div>
                <button id="toggleNames" class="btn btn-link btn-sm p-0 mt-1">
                  å±•é–‹å…¨éƒ¨
                </button>
              </div>
            </div>
          </div>

          <div class="card">
            <div
              class="card-header d-flex align-items-center justify-content-between"
            >
              <span>æŠ½çç´€éŒ„</span>
              <button
                type="button"
                class="btn btn-outline-secondary btn-sm"
                id="exportWinnersCsvBtn"
              >
                åŒ¯å‡ºä¸­çåå–® CSV
              </button>
            </div>
            <div class="card-body">
              <ul id="winnerList" class="list-group"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸­çå½ˆè·³è¦–çª— -->
    <div
      class="modal fade"
      id="winnerModal"
      tabindex="-1"
      aria-labelledby="winnerModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="winnerModalLabel">ğŸ‰ æ­å–œä¸­çï¼</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="é—œé–‰"
            ></button>
          </div>
          <div class="modal-body text-center">
            <div
              id="modalPrize"
              style="font-size: 1.2em; font-weight: bold"
            ></div>
            <div
              id="modalWinner"
              style="font-size: 2em; color: #d9534f; margin: 10px 0"
            ></div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              id="nextDrawBtn"
              data-bs-dismiss="modal"
            >
              æº–å‚™ä¸‹ä¸€æŠ½
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ===== ç‹€æ…‹ =====
      let participants = [];
      let prizes = [];
      let winners = [];
      let currentPrizeIdx = 0;
      let isDrawing = false;
      let enableSound = true;

      // ===== éŸ³æ•ˆ =====
      let audioCtx = null;
      function ensureAudio() {
        if (!audioCtx)
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      function playTick() {
        if (!enableSound) return;
        ensureAudio();
        const o = audioCtx.createOscillator(),
          g = audioCtx.createGain();
        o.type = "square";
        o.frequency.value = 900;
        g.gain.value = 0.03;
        o.connect(g).connect(audioCtx.destination);
        o.start();
        setTimeout(() => o.stop(), 40);
      }
      function playWin() {
        if (!enableSound) return;
        ensureAudio();
        const now = audioCtx.currentTime,
          freqs = [523.25, 659.25, 783.99, 1046.5];
        freqs.forEach((f, i) => {
          const o = audioCtx.createOscillator(),
            g = audioCtx.createGain();
          o.type = "sine";
          o.frequency.setValueAtTime(f, now + i * 0.12);
          g.gain.setValueAtTime(0.0001, now + i * 0.12);
          g.gain.exponentialRampToValueAtTime(0.2, now + i * 0.12 + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, now + i * 0.12 + 0.25);
          o.connect(g).connect(audioCtx.destination);
          o.start(now + i * 0.12);
          o.stop(now + i * 0.12 + 0.28);
        });
      }
      function playOpen() {
        if (!enableSound) return;
        ensureAudio();
        const o = audioCtx.createOscillator(),
          g = audioCtx.createGain();
        o.type = "triangle";
        o.frequency.value = 220;
        g.gain.value = 0.001;
        o.connect(g).connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        g.gain.exponentialRampToValueAtTime(0.15, now + 0.03);
        g.gain.exponentialRampToValueAtTime(0.0001, now + 0.2);
        o.start(now);
        o.stop(now + 0.22);
      }
      $("#soundSwitch").on("change", function () {
        enableSound = this.checked;
      });

      // ===== ç…™ç« =====
      function fireConfetti() {
        const end = Date.now() + 800;
        (function f() {
          confetti({ particleCount: 20, spread: 70, origin: { y: 0.6 } });
          if (Date.now() < end) requestAnimationFrame(f);
        })();
      }

      // ===== åå–®è™•ç† =====
      function updateParticipants() {
        participants = $("#participants")
          .val()
          .split("\n")
          .map((x) => x.trim())
          .filter((x) => x !== "");
        $("#count").text(participants.length);
        updateWheel(); // å·²æ”¹æ‰­è›‹æ©Ÿï¼Œæ­¤å‡½å¼ç•™ç©º
        updateNamesArea();
      }
      $("#participants").on("input", updateParticipants);
      $("#importBtn").on("click", updateParticipants);
      $("#clearBtn").on("click", () => {
        $("#participants").val("");
        updateParticipants();
      });

      // ===== CSV å·¥å…· & åŒ¯å…¥åŒ¯å‡ºï¼ˆä¿æŒä½ çš„å¯¦ä½œï¼‰ =====
      function downloadCsv(csv, filename) {
        const blob = new Blob(["\ufeff" + csv], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }
      function toCSV(rows) {
        return rows
          .map((r) =>
            r
              .map((c) => {
                const s = String(c ?? "");
                return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
              })
              .join(",")
          )
          .join("\n");
      }
      function parseCSV(text) {
        const rows = [];
        let row = [],
          i = 0,
          cur = "",
          inQ = false;
        if (text.charCodeAt(0) === 0xfeff) text = text.slice(1);
        while (i < text.length) {
          const ch = text[i];
          if (inQ) {
            if (ch === `"`) {
              if (text[i + 1] === '"') {
                cur += '"';
                i += 2;
                continue;
              }
              inQ = false;
              i++;
              continue;
            }
            cur += ch;
            i++;
            continue;
          }
          if (ch === `"`) {
            inQ = true;
            i++;
            continue;
          }
          if (ch === ",") {
            row.push(cur);
            cur = "";
            i++;
            continue;
          }
          if (ch === `\n`) {
            row.push(cur);
            rows.push(row);
            row = [];
            cur = "";
            i++;
            continue;
          }
          if (ch === `\r`) {
            i++;
            continue;
          }
          cur += ch;
          i++;
        }
        row.push(cur);
        rows.push(row);
        return rows.filter((r) => !(r.length === 1 && r[0].trim() === ""));
      }

      $("#importNamesCsvBtn").on("click", () =>
        $("#importNamesCsvInput").click()
      );
      $("#importNamesCsvInput").on("change", function () {
        const file = this.files[0];
        if (!file) return;
        file.text().then((text) => {
          const rows = parseCSV(text);
          if (rows.length === 0)
            return Swal.fire("åŒ¯å…¥å¤±æ•—", "æª”æ¡ˆå…§å®¹ç‚ºç©º", "error");
          const header = rows[0].map((x) => x.toLowerCase());
          const hasHeader = header.includes("name") || header.includes("å§“å");
          const start = hasHeader ? 1 : 0;
          const names = [];
          for (let i = start; i < rows.length; i++) {
            const v = (rows[i][0] || "").trim();
            if (v) names.push(v);
          }
          if (!names.length)
            return Swal.fire("åŒ¯å…¥å¤±æ•—", "æ‰¾ä¸åˆ°ä»»ä½•åå­—", "error");
          $("#participants").val(names.join("\n"));
          updateParticipants();
          this.value = "";
          Swal.fire("åŒ¯å…¥å®Œæˆ", `å…± ${names.length} ç­†åå–®`, "success");
        });
      });
      $("#exportNamesCsvBtn").on("click", () =>
        downloadCsv(
          toCSV([["name"], ...participants.map((n) => [n])]),
          "participants.csv"
        )
      );

      $("#importPrizesCsvBtn").on("click", () =>
        $("#importPrizesCsvInput").click()
      );
      $("#importPrizesCsvInput").on("change", function () {
        const file = this.files[0];
        if (!file) return;
        file.text().then((text) => {
          const rows = parseCSV(text);
          if (rows.length === 0)
            return Swal.fire("åŒ¯å…¥å¤±æ•—", "æª”æ¡ˆå…§å®¹ç‚ºç©º", "error");
          const header = rows[0].map((x) => x.toLowerCase());
          const hasHeader =
            header.includes("name") ||
            header.includes("çé …") ||
            header.includes("prize");
          const start = hasHeader ? 1 : 0;
          const list = [];
          for (let i = start; i < rows.length; i++) {
            const r = rows[i];
            const name = (r[0] || "").trim();
            const count = parseInt((r[1] || "1").trim(), 10);
            if (name && Number.isFinite(count) && count > 0)
              list.push({ name, count });
          }
          if (!list.length)
            return Swal.fire(
              "åŒ¯å…¥å¤±æ•—",
              "ç„¡æœ‰æ•ˆçé …è³‡æ–™ï¼ˆéœ€å…©æ¬„ï¼šname,countï¼‰",
              "error"
            );
          prizes = list;
          renderPrizes();
          updateCurrentPrize();
          this.value = "";
          Swal.fire("åŒ¯å…¥å®Œæˆ", `å…± ${list.length} å€‹çé …`, "success");
        });
      });
      $("#exportPrizesCsvBtn").on("click", () =>
        downloadCsv(
          toCSV([
            ["name", "count"],
            ...prizes.map((p) => [p.name, String(p.count)]),
          ]),
          "prizes.csv"
        )
      );

      $("#exportWinnersCsvBtn").on("click", () =>
        downloadCsv(
          toCSV([
            ["order", "prize", "name", "time"],
            ...winners.map((w) => [w.order, w.prize, w.name, w.time]),
          ]),
          "winners.csv"
        )
      );

      // ===== çé …æ–°å¢ / æ’åº / åˆªé™¤ =====
      $("#addPrize").on("click", function () {
        const name = $("#prizeName").val().trim(),
          count = parseInt($("#prizeCount").val(), 10);
        if (!name || !Number.isFinite(count) || count <= 0)
          return Swal.fire(
            "è³‡æ–™ä¸å®Œæ•´",
            "è«‹è¼¸å…¥æœ‰æ•ˆçš„çé …åç¨±èˆ‡æ•¸é‡",
            "warning"
          );
        prizes.push({ name, count });
        $("#prizeName").val("");
        $("#prizeCount").val(1);
        renderPrizes();
        updateCurrentPrize();
      });
      function renderPrizes() {
        const $list = $("#prizeList").empty();
        prizes.forEach((p, i) =>
          $list.append(`<div class="list-group-item d-flex justify-content-between align-items-center" data-idx="${i}">
          <span>${i + 1}. ${p.name} <span class="badge bg-secondary">${
            p.count
          }</span></span>
          <button type="button" class="btn btn-danger btn-sm removePrize">åˆªé™¤</button>
        </div>`)
        );
        $("#prizeList").sortable({
          update: function () {
            const old = prizes.slice();
            const order = $(this)
              .children()
              .map(function () {
                return $(this).data("idx");
              })
              .get();
            prizes = order.map((idx) => old[idx]);
            renderPrizes();
            updateCurrentPrize();
          },
        });
      }
      $("#prizeList").on("click", ".removePrize", function () {
        const idx = $(this).closest(".list-group-item").data("idx");
        prizes.splice(idx, 1);
        renderPrizes();
        updateCurrentPrize();
      });

      // =====ï¼ˆèˆŠï¼‰è½‰ç›¤ï¼šä¿ç•™ç©ºå¯¦ä½œ =====
      function updateWheel() {
        /* å·²æ”¹æ‰­è›‹æ©Ÿï¼Œé€™è£¡ç•™ç™½å³å¯ */
      }

      // ===== åå–®é¡¯ç¤ºï¼ˆ3 è¡Œæ”¶æŠ˜ï¼‰ =====
      function updateNamesArea() {
        $("#wheelNames").text(participants.join(", "));
        clampNames(true);
        const el = document.getElementById("wheelNames");
        $("#toggleNames").toggle(el.scrollHeight > el.clientHeight + 1);
      }
      function clampNames(should) {
        const $n = $("#wheelNames");
        if (should) {
          $n.addClass("clamp-3");
          $("#toggleNames").text("å±•é–‹å…¨éƒ¨");
        } else {
          $n.removeClass("clamp-3");
          $("#toggleNames").text("æ”¶åˆ");
        }
        $("#toggleNames").data("expanded", !should);
      }
      $("#toggleNames").on("click", function () {
        const expanded = $(this).data("expanded") === true;
        clampNames(expanded);
      });

      // ===== é¡¯ç¤ºç›®å‰çé … =====
      function updateCurrentPrize() {
        if (prizes.length > 0 && currentPrizeIdx < prizes.length)
          $("#currentPrize").text("ç•¶å‰çé …ï¼š" + prizes[currentPrizeIdx].name);
        else $("#currentPrize").text("æ‰€æœ‰çé …å·²æŠ½å®Œ");
      }

      // ===== ç»ç’ƒè‰™å…§æ—‹è½‰è† å›Š =====
      function startGlassSpin() {
        const $inner = $("#gachaInner");
        if (!$inner.length) return;

        // â˜… å·²ç¶“æœ‰è»Œé“åœ¨è·‘å°±ä¸è¦é‡å»ºï¼ˆé¿å…é‡è¦† appendï¼‰
        if ($inner.children(".track").length) {
          // è‹¥ä½ æ›¾ç¶“ç”¨é pause ä¹Ÿå¯ä»¥åœ¨é€™è£¡æ¢å¾©ï¼š
          // $inner.find('.track').css('animation-play-state','running');
          return;
        }

        const N = 10; // ç»ç’ƒè‰™å…§åŒæ™‚çœ‹è¦‹å¹¾é¡†å°è† å›Š
        for (let i = 0; i < N; i++) {
          const r = 55 + Math.random() * 38; // åŠå¾‘
          const hue = Math.floor(Math.random() * 360); // é¡è‰²
          const dur = (2.2 + Math.random() * 2.4).toFixed(2) + "s"; // æ—‹è½‰æ™‚é–“
          const del = (-Math.random() * 3).toFixed(2) + "s"; // å•Ÿå‹•å»¶é²
          const dir = Math.random() < 0.5 ? "cw" : "ccw"; // æ–¹å‘

          const $track = $(`<div class="track ${dir}"></div>`).css({
            "--dur": dur,
            "--delay": del,
          });
          const $orb = $('<div class="orb"></div>').css({
            "--hue": hue,
            "--r": `${r}px`,
          });

          $track.append($orb);
          $inner.append($track);
        }
      }
      function stopGlassSpin() {
        $("#gachaInner").empty();
      }

      // ===== å‡ç´šç‰ˆæ‰­è›‹å‹•ç•«ï¼šæ‰è½â†’åˆ†é«”â†’é‡‘è‰²å¡ç‰‡ï¼ˆå«ç»ç’ƒè‰™æ—‹è½‰å•Ÿåœï¼‰ =====
      function runGachaAnimationPro(winnerName, prizeName, done) {
        const $m = $("#gachaMachine");
        $m.addClass("crank");
        setTimeout(() => $m.removeClass("crank"), 700);

        // é–‹å§‹ç»ç’ƒè‰™æ—‹è½‰
        startGlassSpin();

        const hue = Math.floor(Math.random() * 360);
        const $drop = $('<div class="capsule"></div>').css("--hue", hue);
        $m.append($drop);
        playTick();
        requestAnimationFrame(() => $drop.addClass("animate"));

        setTimeout(() => {
          // åœæ­¢ç»ç’ƒè‰™æ—‹è½‰
          // stopGlassSpin();

          $drop.remove();
          const $r = $(`<div class="capsule-x" style="--hue:${hue}">
              <div class="half top"></div>
              <div class="half bottom"></div>
              <div class="ticket"><div class="t1">ğŸ† ${prizeName}</div><div class="t2">ğŸ‘¤ ${winnerName}</div></div>
            </div>`);
          $m.append($r);

          playOpen();
          requestAnimationFrame(() => $r.addClass("reveal"));
          fireConfetti();

          setTimeout(() => {
            $r.addClass("fadeout");
            done && done();
            setTimeout(() => $r.remove(), 450);
          }, 1100);
        }, 2200);
      }

      // ===== æŠ½ç =====
      const bsWinnerModal = new bootstrap.Modal(
        document.getElementById("winnerModal")
      );
      $("#gachaMachine").on("click", () => $("#drawBtn").trigger("click"));

      $("#drawBtn").on("click", function () {
        if (isDrawing) return;
        if (currentPrizeIdx >= prizes.length)
          return Swal.fire(
            "æ‰€æœ‰çé …å·²æŠ½å®Œ",
            "è«‹æ–°å¢çé …æˆ–é‡æ–°æ•´ç†é é¢",
            "info"
          );
        if (participants.length === 0 || prizes.length === 0)
          return Swal.fire("è³‡æ–™ä¸è¶³", "è«‹ç¢ºèªåå–®èˆ‡çé …çš†å·²è¨­å®š", "warning");
        if (prizes[currentPrizeIdx].count <= 0) {
          currentPrizeIdx++;
          updateCurrentPrize();
          if (currentPrizeIdx >= prizes.length)
            Swal.fire("æ‰€æœ‰çé …å·²æŠ½å®Œ", "è«‹æ–°å¢çé …æˆ–é‡æ–°æ•´ç†é é¢", "info");
          return;
        }
        isDrawing = true;
        const winnerIdx = Math.floor(Math.random() * participants.length);
        const winner = participants[winnerIdx];
        const prizeName = prizes[currentPrizeIdx].name;
        runGachaAnimationPro(winner, prizeName, () => showWinner(winnerIdx));
      });

      function showWinner(winnerIdx) {
        const winner = participants[winnerIdx];
        const prizeName = prizes[currentPrizeIdx].name;

        $("#modalPrize").text("çé …ï¼š" + prizeName);
        $("#modalWinner").text(winner);
        bsWinnerModal.show();

        playWin();
        fireConfetti();

        const now = new Date();
        winners.unshift({
          order: winners.length + 1,
          prize: prizeName,
          name: winner,
          time: now.toLocaleString(),
        });
        $("#winnerList").prepend(
          `<li class="list-group-item">${winners[0].order}. ${winners[0].prize} - ${winners[0].name}<span class="text-muted float-end">${winners[0].time}</span></li>`
        );

        // ä¸€æ¬¡ç§»é™¤æ‰€æœ‰åŒå
        participants = participants.filter((n) => n !== winner);
        $("#participants").val(participants.join("\n"));

        // æ‰£çæ•¸ / ä¸‹ä¸€çé …
        prizes[currentPrizeIdx].count--;
        if (prizes[currentPrizeIdx].count <= 0) currentPrizeIdx++;

        updateParticipants();
        renderPrizes();
        updateCurrentPrize();
        isDrawing = false;
      }

      $("#nextDrawBtn").on("click", function () {
        if (currentPrizeIdx >= prizes.length)
          Swal.fire("æ‰€æœ‰çé …å·²æŠ½å®Œ", "æ­å–œå®Œæˆæ‰€æœ‰æŠ½çï¼", "success");
      });

      // åˆå§‹
      $(function () {
        updateParticipants();
        renderPrizes();
        updateCurrentPrize();
        clampNames(true);
        $("#toggleNames").hide();
        startGlassSpin();
      });
    </script>
  </body>
</html>
