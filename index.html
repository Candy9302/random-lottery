<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>æŠ½çæ´»å‹•</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- jQuery / jQuery UI (for sortable) -->
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
    />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
      #wheel {
        border: 2px solid #ccc;
        border-radius: 50%;
        background: #fff;
      }
      .card {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      }
      .list-group-item {
        cursor: grab;
      }
      /* åƒèˆ‡åå–®ä¸‰è¡Œæ”¶æŠ˜ */
      #wheelNames {
        white-space: normal;
        word-break: break-word;
      }
      .clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div class="container mt-3">
      <!-- æ´»å‹•åç¨±å€ -->
      <div class="row mb-3">
        <div class="col-12 d-flex align-items-center">
          <img
            src="gce.png"
            alt="æ´»å‹•Logo"
            style="height: 40px; margin-right: 10px"
          />
          <h2 class="mb-0">æŠ½çæ´»å‹•</h2>
        </div>
      </div>

      <div class="row">
        <!-- å·¦å´ï¼šåå–®èˆ‡çé … -->
        <div class="col-md-5">
          <div class="card mb-3">
            <div class="card-header">åå–®è¼¸å…¥å€</div>
            <div class="card-body">
              <textarea
                id="participants"
                class="form-control mb-2"
                rows="8"
                placeholder="æ¯è¡Œä¸€å€‹åé¡"
              ></textarea>
              <div class="mb-2">
                <button
                  type="button"
                  class="btn btn-primary btn-sm"
                  id="importBtn"
                >
                  åŒ¯å…¥åå–®
                </button>
                <button
                  type="button"
                  class="btn btn-secondary btn-sm"
                  id="clearBtn"
                >
                  æ¸…é™¤
                </button>
              </div>
              <div>ç›®å‰åå–®æ•¸ï¼š<span id="count">0</span></div>
            </div>
          </div>

          <div class="card mb-3">
            <div class="card-header">çé …è³‡æ–™è¼¸å…¥å€</div>
            <div class="card-body">
              <div class="input-group mb-2">
                <input
                  type="text"
                  id="prizeName"
                  class="form-control"
                  placeholder="çé …åç¨±"
                />
                <input
                  type="number"
                  id="prizeCount"
                  class="form-control"
                  value="1"
                  min="1"
                  style="max-width: 90px"
                />
                <button type="button" class="btn btn-success" id="addPrize">
                  æ–°å¢
                </button>
              </div>
              <div id="prizeList" class="list-group"></div>
            </div>
          </div>
        </div>

        <!-- å³å´ï¼šè½‰ç›¤èˆ‡ç´€éŒ„ -->
        <div class="col-md-7">
          <div class="card mb-3">
            <div class="card-header">æŠ½çè½‰ç›¤å€</div>
            <div class="card-body text-center">
              <div id="currentPrize" class="mb-2 fw-bold"></div>
              <canvas
                id="wheel"
                width="300"
                height="300"
                style="margin-bottom: 10px"
              ></canvas>
              <div>
                <button class="btn btn-warning" id="drawBtn">æŠ½ç</button>
              </div>

              <!-- åƒèˆ‡åå–®ï¼ˆå¯æ”¶æŠ˜ï¼‰ -->
              <div class="mt-3 text-start">
                <div class="mb-1 fw-semibold">åƒèˆ‡åå–®ï¼š</div>
                <div id="wheelNames" class="clamp-3"></div>
                <button id="toggleNames" class="btn btn-link btn-sm p-0 mt-1">
                  å±•é–‹å…¨éƒ¨
                </button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">æŠ½çç´€éŒ„</div>
            <div class="card-body">
              <ul id="winnerList" class="list-group"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸­çå½ˆè·³è¦–çª— -->
    <div
      class="modal fade"
      id="winnerModal"
      tabindex="-1"
      aria-labelledby="winnerModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="winnerModalLabel">ğŸ‰ æ­å–œä¸­çï¼</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="é—œé–‰"
            ></button>
          </div>
          <div class="modal-body text-center">
            <div
              id="modalPrize"
              style="font-size: 1.2em; font-weight: bold"
            ></div>
            <div
              id="modalWinner"
              style="font-size: 2em; color: #d9534f; margin: 10px 0"
            ></div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              id="nextDrawBtn"
              data-bs-dismiss="modal"
            >
              æº–å‚™ä¸‹ä¸€æŠ½
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ===== ç‹€æ…‹ =====
      let participants = [];
      let prizes = [];
      let winners = [];
      let currentPrizeIdx = 0;
      let isDrawing = false;

      // ===== åå–®è™•ç† =====
      function updateParticipants() {
        participants = $("#participants")
          .val()
          .split("\n")
          .map((x) => x.trim())
          .filter((x) => x !== "");
        $("#count").text(participants.length);
        updateWheel();
        updateNamesArea();
      }
      $("#participants").on("input", updateParticipants);
      $("#importBtn").on("click", updateParticipants);
      $("#clearBtn").on("click", () => {
        $("#participants").val("");
        updateParticipants();
      });

      // ===== çé …æ–°å¢ / æ’åº / åˆªé™¤ =====
      $("#addPrize").on("click", function () {
        const name = $("#prizeName").val().trim();
        const count = parseInt($("#prizeCount").val(), 10);
        if (!name || !Number.isFinite(count) || count <= 0) return;
        prizes.push({ name, count });
        $("#prizeName").val("");
        $("#prizeCount").val(1);
        renderPrizes();
        updateCurrentPrize();
      });

      function renderPrizes() {
        const $list = $("#prizeList").empty();
        prizes.forEach((p, i) => {
          $list.append(
            `<div class="list-group-item d-flex justify-content-between align-items-center" data-idx="${i}">
           <span>${i + 1}. ${p.name} <span class="badge bg-secondary">${
              p.count
            }</span></span>
           <button type="button" class="btn btn-danger btn-sm removePrize">åˆªé™¤</button>
         </div>`
          );
        });
        // sortable
        $("#prizeList").sortable({
          update: function () {
            const old = prizes.slice();
            const newOrderIdx = $(this)
              .children()
              .map(function () {
                return $(this).data("idx");
              })
              .get();
            prizes = newOrderIdx.map((idx) => old[idx]);
            renderPrizes();
            updateCurrentPrize();
          },
        });
      }
      $("#prizeList").on("click", ".removePrize", function () {
        const idx = $(this).closest(".list-group-item").data("idx");
        prizes.splice(idx, 1);
        renderPrizes();
        updateCurrentPrize();
      });

      // ===== è½‰ç›¤ =====
      function updateWheel() {
        const canvas = document.getElementById("wheel");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        const names = participants;
        const len = names.length;
        ctx.clearRect(0, 0, 300, 300);
        if (!len) return;
        const angle = (2 * Math.PI) / len;
        for (let i = 0; i < len; i++) {
          ctx.beginPath();
          ctx.moveTo(150, 150);
          ctx.arc(150, 150, 140, i * angle, (i + 1) * angle);
          ctx.closePath();
          ctx.fillStyle = `hsl(${(i * 360) / len},70%,70%)`;
          ctx.fill();
          ctx.save();
          ctx.translate(150, 150);
          ctx.rotate((i + 0.5) * angle);
          ctx.textAlign = "right";
          ctx.font = "16px Arial";
          ctx.fillStyle = "#333";
          ctx.fillText(names[i], 130, 8);
          ctx.restore();
        }
        // æŒ‡é‡
        ctx.beginPath();
        ctx.moveTo(150, 10);
        ctx.lineTo(140, 30);
        ctx.lineTo(160, 30);
        ctx.closePath();
        ctx.fillStyle = "#d9534f";
        ctx.fill();
      }

      function highlightWheel(idx) {
        updateWheel();
        const canvas = document.getElementById("wheel");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        const len = participants.length;
        if (!len) return;
        const angle = (2 * Math.PI) / len;
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(150, 150);
        ctx.arc(150, 150, 140, idx * angle, (idx + 1) * angle);
        ctx.closePath();
        ctx.fillStyle = "rgba(255,215,0,.5)";
        ctx.fill();
        ctx.restore();
      }

      // ===== åƒèˆ‡åå–®é¡¯ç¤ºï¼ˆ3 è¡Œæ”¶æŠ˜ï¼‰ =====
      function updateNamesArea() {
        $("#wheelNames").text(participants.join(", "));
        clampNames(true);
        // åˆ¤æ–·æ˜¯å¦éœ€è¦é¡¯ç¤ºæŒ‰éˆ•ï¼ˆå…§å®¹é«˜åº¦è¶…é 3 è¡Œï¼‰
        const el = document.getElementById("wheelNames");
        const needBtn = el.scrollHeight > el.clientHeight + 1;
        $("#toggleNames").toggle(needBtn);
      }
      function clampNames(shouldClamp) {
        const $names = $("#wheelNames");
        if (shouldClamp) {
          $names.addClass("clamp-3");
          $("#toggleNames").text("å±•é–‹å…¨éƒ¨");
        } else {
          $names.removeClass("clamp-3");
          $("#toggleNames").text("æ”¶åˆ");
        }
        $("#toggleNames").data("expanded", !shouldClamp);
      }
      $("#toggleNames").on("click", function () {
        const expanded = $(this).data("expanded") === true;
        clampNames(expanded); // å¦‚æœå·²å±•é–‹ -> æ”¶åˆï¼›è‹¥æ”¶åˆ -> å±•é–‹
      });

      // ===== é¡¯ç¤ºç›®å‰çé … =====
      function updateCurrentPrize() {
        if (prizes.length > 0 && currentPrizeIdx < prizes.length) {
          $("#currentPrize").text("ç•¶å‰çé …ï¼š" + prizes[currentPrizeIdx].name);
        } else {
          $("#currentPrize").text("æ‰€æœ‰çé …å·²æŠ½å®Œ");
        }
      }

      // ===== æŠ½ç =====
      const winnerModalEl = document.getElementById("winnerModal");
      const bsWinnerModal = new bootstrap.Modal(winnerModalEl);

      $("#drawBtn").on("click", function () {
        if (isDrawing) return;
        if (
          participants.length === 0 ||
          prizes.length === 0 ||
          currentPrizeIdx >= prizes.length
        ) {
          alert("è«‹ç¢ºèªåå–®èˆ‡çé …çš†å·²è¨­å®šï¼Œä¸”å°šæœ‰çé …å¯æŠ½");
          return;
        }
        if (prizes[currentPrizeIdx].count <= 0) {
          currentPrizeIdx++;
          updateCurrentPrize();
          return;
        }

        isDrawing = true;
        const winnerIdx = Math.floor(Math.random() * participants.length);
        const rounds = 20 + Math.floor(Math.random() * 10);
        let step = 0;
        const timer = setInterval(() => {
          const idx = (winnerIdx + step) % participants.length;
          highlightWheel(idx);
          step++;
          if (step > rounds) {
            clearInterval(timer);
            setTimeout(() => showWinner(winnerIdx), 500);
          }
        }, 80);
      });

      function showWinner(winnerIdx) {
        const winner = participants[winnerIdx];
        const prizeName = prizes[currentPrizeIdx].name;

        // å½ˆçª—
        $("#modalPrize").text("çé …ï¼š" + prizeName);
        $("#modalWinner").text(winner);
        bsWinnerModal.show();

        // ç´€éŒ„ï¼ˆæœ€æ–°åœ¨æœ€ä¸Šé¢ï¼‰
        const now = new Date();
        winners.unshift({
          order: winners.length + 1,
          prize: prizeName,
          name: winner,
          time: now.toLocaleString(),
        });
        $("#winnerList").prepend(
          `<li class="list-group-item">${winners[0].order}. ${winners[0].prize} - ${winners[0].name}
        <span class="text-muted float-end">${winners[0].time}</span></li>`
        );

        // **ä¸€æ¬¡ç§»é™¤åå–®ä¸­æ‰€æœ‰é‡è¤‡çš„ä¸­çè€…**
        participants = participants.filter((n) => n !== winner);
        $("#participants").val(participants.join("\n"));

        // æ‰£çæ•¸ / åˆ‡ä¸‹å€‹çé …
        prizes[currentPrizeIdx].count--;
        if (prizes[currentPrizeIdx].count <= 0) {
          currentPrizeIdx++;
        }

        updateParticipants(); // æœƒé †ä¾¿é‡ç•«è½‰ç›¤ & åå–®å€
        renderPrizes();
        updateCurrentPrize();
        isDrawing = false;
      }

      $("#nextDrawBtn").on("click", function () {
        if (currentPrizeIdx >= prizes.length) {
          alert("å…¨éƒ¨æŠ½å®Œ");
        }
      });

      // é—œé–‰å¾Œè‹¥é‚„æœ‰çä¸”æœ‰åå–®ï¼Œç¹¼çºŒä¸‹ä¸€æŠ½ï¼ˆå¯é—œæ‰é€™æ®µå°±ä¸è‡ªå‹•ï¼‰
      winnerModalEl.addEventListener("hidden.bs.modal", function () {
        if (
          currentPrizeIdx < prizes.length &&
          prizes[currentPrizeIdx].count > 0 &&
          participants.length > 0
        ) {
          // è‡ªå‹•ä¸‹ä¸€æŠ½ï¼ˆæƒ³æ‰‹å‹•å°±è¨»è§£æ‰ï¼‰
          // $('#drawBtn').trigger('click');
        }
      });

      // åˆå§‹
      $(function () {
        updateParticipants();
        renderPrizes();
        updateCurrentPrize();
        clampNames(true);
        $("#toggleNames").hide(); // åˆå§‹å…ˆéš±è—ï¼Œå…§å®¹é•·åº¦å†æ±ºå®šæ˜¯å¦é¡¯ç¤º
      });
    </script>
  </body>
</html>
